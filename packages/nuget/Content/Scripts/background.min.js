// Generated by CoffeeScript 1.3.3

/*
  background.js 0.3.0
  (c) 2011, 2012 Kevin Malakoff.
  Mixin is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/background/blob/master/LICENSE
  Dependencies: None.
*/(function(){var e,t,n,r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};n=this,e=this.Background=typeof exports!="undefined"?exports:{},e.VERSION="0.3.0",t=function(){var e;return e={},arguments.length>0&&(e.start=arguments[0]),arguments.length>1&&(e.tick=arguments[1]),arguments.length>2&&(e.finish=arguments[2]),e},e._JobContainer=function(){function r(e){this.frequency=e,this.jobs=[],this.timeout=0,this.in_destroy=!1}return r.prototype.destroy=function(){return this.in_destroy=!0},r.prototype.isDestroyed=function(){return this.in_destroy||this.destroyed},r.prototype.isEmpty=function(){return this.jobs.length===0},r.prototype.tick=function(){if(this.in_destroy){this._doDestroy();return}this._doTick(),this.in_destroy&&this._doDestroy()},r.prototype.clear=function(){var e;while(e=this.jobs.shift())e.destroy(!0);if(this.timeout)return n.clearInterval(this.timeout),this.timeout=null},r.prototype._appendJob=function(r){var i,s=this;arguments.length>1&&(r=t.apply(null,arguments));if(this.isDestroyed())throw"Trying to append a job to a destroyed container";r instanceof e.Job?i=r:i=new e.Job(r),this.jobs.push(i);if(!this.timeout)return this.timeout=n.setInterval(function(){return s.tick()},this.frequency)},r.prototype._waitForJobs=function(){if(this.timeout)return n.clearInterval(this.timeout),this.timeout=null},r.prototype._doDestroy=function(){if(!this.in_destroy||this.is_destroyed)throw"Destroy state is corrupted";return this.is_destroyed=!0,this.clear()},r}(),e._ArrayIterator=function(){function e(e,t,n){this.batch_length=e,this.total_count=t,this.current_range=n;if(!this.batch_length||this.total_count===void 0||!this.current_range)throw"Iterator parameters invalid";this.reset()}return e.prototype.reset=function(){return this.batch_index=-1,this.batch_count=Math.ceil(this.total_count/this.batch_length)},e.prototype.isDone=function(){return this.batch_index>=this.batch_count-1},e.prototype.updateCurrentRange=function(){var e,t;return t=this.batch_index*this.batch_length,e=t+this.batch_length,e>this.total_count&&(e=this.total_count),t>=e?this.current_range._setIsDone():(this.current_range._addBatchLength(e-t),this.current_range)},e.prototype.step=function(){return this.isDone()?this.current_range._setIsDone():(this.batch_index++,this.batch_index===0?this.current_range:this.updateCurrentRange())},e}(),e.Job=function(){function e(e){this.functions=e,arguments.length>1&&(this.functions=t.apply(null,arguments));if(!e)throw"Missing task functions";typeof this.functions=="function"&&(this.functions={tick:this.functions}),this.was_completed=!1}return e.prototype.destroy=function(){return this._cleanup(),this.functions=null},e.prototype.run=function(){return this.functions.start&&(this.functions.start(),this.functions.start=null),this.was_completed=this.functions.tick?this.functions.tick():!0,this.was_completed&&this._cleanup(),this.was_completed},e.prototype._cleanup=function(){if(this.functions.finish)return this.functions.finish(this.was_completed),this.functions.finish=null},e}(),e.JobQueue=function(e){function t(e){t.__super__.constructor.call(this,e),this.current_job=null}return i(t,e),t.prototype._doTick=function(){if(!this.current_job){if(!this.jobs.length){this._waitForJobs();return}this.current_job=this.jobs.shift()}if(this.current_job.run())return this.current_job.destroy(!1),this.current_job=null},t.prototype.push=function(e){return this._appendJob.apply(this,arguments)},t.prototype._doDestroy=function(){return this.current_job&&(this.current_job.destroy(!0),this.current_job=null),t.__super__._doDestroy.call(this)},t}(e._JobContainer),e.JobList=function(e){function t(e){t.__super__.constructor.call(this,e)}return i(t,e),t.prototype._doTick=function(){var e,t,n,r,i;if(!this.jobs.length){this._waitForJobs();return}t=this.jobs.slice(),i=[];for(n=0,r=t.length;n<r;n++){e=t[n];if(!e.run())continue;this.jobs.splice(this.jobs.indexOf(e),1),i.push(e.destroy(!1))}return i},t.prototype.append=function(e){return this._appendJob.apply(this,arguments)},t}(e._JobContainer),e.Range=function(){function e(e,t){this.index=e,this.excluded_boundary=t;if(this.index===void 0||!this.excluded_boundary)throw"Background.Range: parameters invalid";return this}return e.prototype.isDone=function(){return this.index>=this.excluded_boundary},e.prototype.step=function(){return this.index++,this.index>=this.excluded_boundary?-1:this.index},e.prototype.getItem=function(e){return e[this.index]},e.prototype.getSlice=function(e){return e.slice(this.index,this.excluded_boundary)},e.prototype._setIsDone=function(){return this.index=-1,this.excluded_boundary=-1,this},e.prototype._addBatchLength=function(e){if(!e)throw"Background.Range._addBatchLength: batch_length invalid";return this.excluded_boundary+=e,this},e.prototype.reset=function(){return this.index=0,this},e.prototype._stepToEnd=function(){return this.index=this.excluded_boundary},e}(),e.Range_xN=function(){function e(e,t){this.ranges=e,this.batch_length=t;if(!this.ranges||!this.batch_length)throw"Background.Range_xN: parameters invalid";return this.batch_index=0,this}return e.prototype.isDone=function(){return this.batch_index>=this.batch_length},e.prototype.step=function(){var e,t;this.batch_index++,t=this.ranges.length-1;while(t>=0){e=this.ranges[t],e.step();if(!e.isDone())return this;e.reset(),t--}return this._setIsDone(),null},e.prototype.getItems=function(e){var t,n,r;r=[];for(n in e)t=e[n],r.push(t[this.ranges[n].index]);return r},e.prototype.getCombinations=function(e){var t,n,r,i,s;n=[];while(!this.isDone()){t=[],s=this.ranges;for(r in s)i=s[r],t.push(i.getItem(e[r]));n.push(t),this.step()}return n},e.prototype._setIsDone=function(){return this.batch_index=-1,this.batch_length=-1,this},e.prototype._addBatchLength=function(e){if(!e)throw"Background.Range_xN._addBatchLength: batch_length invalid";return this.batch_index=0,this.batch_length=e,this},e}(),e.ArrayIterator=function(t){function n(t,r){var i;this.array=t;if(!this.array)throw"Background.ArrayIterator: missing array";this.reset(),i=r<this.array.length?r:this.array.length?this.array.length:1,n.__super__.constructor.call(this,r,this.array.length,new e.Range(0,i))}return i(n,t),n.prototype.nextByItem=function(e){this.step();while(!this.current_range.isDone())e(this.current_range.getItem(this.array),this.current_range.index,this.array),this.current_range.step();return this.isDone()},n.prototype.nextBySlice=function(e){return this.step(),this.current_range.isDone()||e(this.current_range.getSlice(this.array),this.current_range,this.array),this.current_range._stepToEnd(),this.isDone()},n.prototype.nextByRange=function(e){return this.step(),this.current_range.isDone()||e(this.current_range,this.array),this.isDone()},n}(e._ArrayIterator),e.ArrayIterator_xN=function(t){function n(t,r){var i,s,o,u,a,f,l,c,h;this.arrays=t;if(!this.arrays)throw"Background.ArrayIterator_xN: missing arrays";s=1,c=this.arrays;for(u=0,f=c.length;u<f;u++)i=c[u],s*=i.length;this.reset(),o=[],h=this.arrays;for(a=0,l=h.length;a<l;a++)i=h[a],o.push(new e.Range(0,i.length));n.__super__.constructor.call(this,r,s,new e.Range_xN(o,r))}return i(n,t),n.prototype.nextByItems=function(e){this.step();while(!this.current_range.isDone())e(this.current_range.getItems(this.arrays),this.current_range,this.arrays),this.current_range.step();return this.isDone()},n.prototype.nextByCombinations=function(e){return this.step(),this.current_range.isDone()||e(this.current_range.getCombinations(this.arrays),this.current_range,this.array),this.isDone()},n.prototype.nextByRange=function(e){return this.step(),this.current_range.isDone()||e(this.current_range,this.arrays),this.isDone()},n}(e._ArrayIterator)}).call(this);