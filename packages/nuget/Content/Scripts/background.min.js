// Generated by CoffeeScript 1.3.3

/*
  background.js 0.2.2
  (c) 2011, 2012 Kevin Malakoff.
  Mixin is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/background/blob/master/LICENSE
  Dependencies: None.
*/(function(){var e,t,n={}.hasOwnProperty,r=function(e,t){function i(){this.constructor=e}for(var r in t)n.call(t,r)&&(e[r]=t[r]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};t=this,e=this.Background=typeof exports!="undefined"?exports:{},e.VERSION="0.2.2",e._JobContainer=function(){function n(e){this.frequency=e,this.jobs=[],this.timeout=0,this.being_destroyed=!1}return n.prototype.destroy=function(){return this.being_destroyed=!0},n.prototype.isDestroyed=function(){return this.being_destroyed||this.destroyed},n.prototype.isEmpty=function(){return this.jobs.length===0},n.prototype.tick=function(){if(this.being_destroyed){this._doDestroy();return}this._doTick(),this.being_destroyed&&this._doDestroy()},n.prototype.clear=function(){var e;while(e=this.jobs.shift())e.destroy(!0);if(this.timeout)return t.clearInterval(this.timeout),this.timeout=null},n.prototype._appendJob=function(n,r,i){var s,o=this;if(this.isDestroyed())throw new Error("Background._JobContainer._appendJob: trying to append a job to a destroyed container");e.Job.isAJob(n)?s=n:s=new e.Job(n,r,i),this.jobs.push(s);if(!this.timeout)return this.timeout=t.setInterval(function(){return o.tick()},this.frequency)},n.prototype._waitForJobs=function(){if(this.timeout)return t.clearInterval(this.timeout),this.timeout=null},n.prototype._doDestroy=function(){if(!this.being_destroyed||this.is_destroyed)throw new Error("Background._JobContainer.destroy: destroy state is corrupted");return this.is_destroyed=!0,this.clear()},n}(),e._ArrayIterator=function(){function e(e,t,n){this.batch_length=e,this.total_count=t,this.current_range=n;if(!this.batch_length||this.total_count===void 0||!this.current_range)throw new Error("Background._ArrayIterator: parameters invalid");this.reset()}return e.prototype.reset=function(){return this.batch_index=-1,this.batch_count=Math.ceil(this.total_count/this.batch_length)},e.prototype.isDone=function(){return this.batch_index>=this.batch_count-1},e.prototype.updateCurrentRange=function(){var e,t;return t=this.batch_index*this.batch_length,e=t+this.batch_length,e>this.total_count&&(e=this.total_count),t>=e?this.current_range._setIsDone():(this.current_range._addBatchLength(e-t),this.current_range)},e.prototype.step=function(){return this.isDone()?this.current_range._setIsDone():(this.batch_index++,this.batch_index===0?this.current_range:this.updateCurrentRange())},e}(),e.Job=function(){function e(e,t,n){this.init_fn=e,this.run_fn=t,this.destroy_fn=n;if(!this.run_fn)throw new Error("run_fn is mandatory");this.was_completed=!1}return e.prototype.destroy=function(){return this._cleanup(),this.run_fn=null,this.init_fn=null,this.destroy_fn=null},e.prototype.run=function(){return this.init_fn&&(this.init_fn(),this.init_fn=null),this.was_completed=this.run_fn(),this.was_completed&&this._cleanup(),this.was_completed},e.prototype._cleanup=function(){if(this.destroy_fn)return this.destroy_fn(this.was_completed),this.destroy_fn=null},e.isAJob=function(e){return e&&typeof e=="object"&&"constructor"in e&&"name"in e.constructor&&e.constructor.name==="Job"},e}(),e.JobQueue=function(e){function t(e){t.__super__.constructor.call(this,e),this.current_job=null}return r(t,e),t.prototype._doTick=function(){if(!this.current_job){if(!this.jobs.length){this._waitForJobs();return}this.current_job=this.jobs.shift()}if(this.current_job.run())return this.current_job.destroy(!1),this.current_job=null},t.prototype.push=function(e,t,n){return this._appendJob(e,t,n)},t.prototype._doDestroy=function(){return this.current_job&&(this.current_job.destroy(!0),this.current_job=null),t.__super__._doDestroy.call(this)},t}(e._JobContainer),e.JobList=function(e){function t(e){t.__super__.constructor.call(this,e)}return r(t,e),t.prototype._doTick=function(){var e,t,n,r,i;if(!this.jobs.length){this._waitForJobs();return}t=this.jobs.slice(),i=[];for(n=0,r=t.length;n<r;n++){e=t[n];if(!e.run())continue;this.jobs.splice(this.jobs.indexOf(e),1),i.push(e.destroy(!1))}return i},t.prototype.append=function(e,t,n){return this._appendJob(e,t,n)},t}(e._JobContainer),e.Range=function(){function e(e,t){this.index=e,this.excluded_boundary=t;if(this.index===void 0||!this.excluded_boundary)throw new Error("Background.Range: parameters invalid");return this}return e.prototype.isDone=function(){return this.index>=this.excluded_boundary},e.prototype.step=function(){return this.index++,this.index>=this.excluded_boundary?-1:this.index},e.prototype.getItem=function(e){return e[this.index]},e.prototype.getSlice=function(e){return e.slice(this.index,this.excluded_boundary)},e.prototype._setIsDone=function(){return this.index=-1,this.excluded_boundary=-1,this},e.prototype._addBatchLength=function(e){if(!e)throw new Error("Background.Range._addBatchLength: batch_length invalid");return this.excluded_boundary+=e,this},e.prototype.reset=function(){return this.index=0,this},e.prototype._stepToEnd=function(){return this.index=this.excluded_boundary},e}(),e.Range_xN=function(){function e(e,t){this.ranges=e,this.batch_length=t;if(!this.ranges||!this.batch_length)throw new Error("Background.Range_xN: parameters invalid");return this.batch_index=0,this}return e.prototype.isDone=function(){return this.batch_index>=this.batch_length},e.prototype.step=function(){var e,t;this.batch_index++,t=this.ranges.length-1;while(t>=0){e=this.ranges[t],e.step();if(!e.isDone())return this;e.reset(),t--}return this._setIsDone(),null},e.prototype.getItems=function(e){var t,n,r;r=[];for(n in e)t=e[n],r.push(t[this.ranges[n].index]);return r},e.prototype.getCombinations=function(e){var t,n,r,i,s;n=[];while(!this.isDone()){t=[],s=this.ranges;for(r in s)i=s[r],t.push(i.getItem(e[r]));n.push(t),this.step()}return n},e.prototype._setIsDone=function(){return this.batch_index=-1,this.batch_length=-1,this},e.prototype._addBatchLength=function(e){if(!e)throw new Error("Background.Range_xN._addBatchLength: batch_length invalid");return this.batch_index=0,this.batch_length=e,this},e}(),e.ArrayIterator=function(t){function n(t,r){var i;this.array=t;if(!this.array)throw new Error("Background.ArrayIterator: missing array");this.reset(),i=r<this.array.length?r:this.array.length?this.array.length:1,n.__super__.constructor.call(this,r,this.array.length,new e.Range(0,i))}return r(n,t),n.prototype.nextByItem=function(e){this.step();while(!this.current_range.isDone())e(this.current_range.getItem(this.array),this.current_range.index,this.array),this.current_range.step();return this.isDone()},n.prototype.nextBySlice=function(e){return this.step(),this.current_range.isDone()||e(this.current_range.getSlice(this.array),this.current_range,this.array),this.current_range._stepToEnd(),this.isDone()},n.prototype.nextByRange=function(e){return this.step(),this.current_range.isDone()||e(this.current_range,this.array),this.isDone()},n}(e._ArrayIterator),e.ArrayIterator_xN=function(t){function n(t,r){var i,s,o,u,a,f,l,c,h;this.arrays=t;if(!this.arrays)throw new Error("Background.ArrayIterator_xN: missing arrays");s=1,c=this.arrays;for(u=0,f=c.length;u<f;u++)i=c[u],s*=i.length;this.reset(),o=[],h=this.arrays;for(a=0,l=h.length;a<l;a++)i=h[a],o.push(new e.Range(0,i.length));n.__super__.constructor.call(this,r,s,new e.Range_xN(o,r))}return r(n,t),n.prototype.nextByItems=function(e){this.step();while(!this.current_range.isDone())e(this.current_range.getItems(this.arrays),this.current_range,this.arrays),this.current_range.step();return this.isDone()},n.prototype.nextByCombinations=function(e){return this.step(),this.current_range.isDone()||e(this.current_range.getCombinations(this.arrays),this.current_range,this.array),this.isDone()},n.prototype.nextByRange=function(e){return this.step(),this.current_range.isDone()||e(this.current_range,this.arrays),this.isDone()},n}(e._ArrayIterator)}).call(this);