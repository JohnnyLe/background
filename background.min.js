/*
 background.js 0.2.0
 (c) 2011 Kevin Malakoff.
 Mixin is freely distributable under the MIT license.
 See the following for full license details:
 https://github.com/kmalakoff/background/blob/master/LICENSE
 Dependencies: None.
*/
var root;var __bind=function(a,b){return function(){return a.apply(b,arguments)}};this.Background||(this.Background={});root=this;Background.VERSION="0.2.0";Background._JobContainer=(function(){function a(b){this.frequency=b;this.jobs=[];this.timeout=0;this.being_destroyed=false}a.prototype.destroy=function(){return this.being_destroyed=true};a.prototype.isDestroyed=function(){return this.being_destroyed||this.destroyed};a.prototype.isEmpty=function(){return this.jobs.length===0};a.prototype.tick=function(){if(this.being_destroyed){this._doDestroy();return}this._doTick();if(this.being_destroyed){this._doDestroy()}};a.prototype.clear=function(){var b;while((b=this.jobs.shift())){b.destroy(true)}if(this.timeout){root.clearInterval(this.timeout);return this.timeout=null}};a.prototype._appendJob=function(e,c,b){var d;if(this.isDestroyed()){throw new Error("Background._JobContainer._appendJob: trying to append a job to a destroyed container")}if(Background.Job.isAJob(e)){d=e}else{d=new Background.Job(e,c,b)}this.jobs.push(d);if(!this.timeout){return this.timeout=root.setInterval((__bind(function(){return this.tick()},this)),this.frequency)}};a.prototype._waitForJobs=function(){if(this.timeout){root.clearInterval(this.timeout);return this.timeout=null}};a.prototype._doDestroy=function(){if(!this.being_destroyed||this.is_destroyed){throw new Error("Background._JobContainer.destroy: destroy state is corrupted")}this.is_destroyed=true;return this.clear()};return a})();Background._ArrayIterator=(function(){function a(d,b,c){this.batch_length=d;this.total_count=b;this.current_range=c;if(!this.batch_length||(this.total_count===void 0)||!this.current_range){throw new Error("Background._ArrayIterator: parameters invalid")}this.reset()}a.prototype.reset=function(){this.batch_index=-1;return this.batch_count=Math.ceil(this.total_count/this.batch_length)};a.prototype.isDone=function(){return this.batch_index>=this.batch_count-1};a.prototype.updateCurrentRange=function(){var c,b;b=this.batch_index*this.batch_length;c=b+this.batch_length;if(c>this.total_count){c=this.total_count}if(b>=c){return this.current_range._setIsDone()}this.current_range._addBatchLength(c-b);return this.current_range};a.prototype.step=function(){if(this.isDone()){return this.current_range._setIsDone()}this.batch_index++;if(this.batch_index===0){return this.current_range}else{return this.updateCurrentRange()}};return a})();Background.Job=(function(){function a(d,c,b){this.init_fn=d;this.run_fn=c;this.destroy_fn=b;if(!this.run_fn){throw new Error("run_fn is mandatory")}this.was_completed=false}a.prototype.destroy=function(){this._cleanup();this.run_fn=null;this.init_fn=null;return this.destroy_fn=null};a.prototype.run=function(){if(this.init_fn){this.init_fn();this.init_fn=null}this.was_completed=this.run_fn();if(this.was_completed){this._cleanup()}return this.was_completed};a.prototype._cleanup=function(){if(this.destroy_fn){this.destroy_fn(this.was_completed);return this.destroy_fn=null}};a.isAJob=function(b){return b&&(typeof b==="object")&&("constructor" in b)&&("name" in b.constructor)&&(b.constructor.name==="Job")};return a})();if(typeof exports!=="undefined"){exports.Background.Job=Background.Job}var __hasProp=Object.prototype.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};Background.JobQueue=(function(){__extends(a,Background._JobContainer);function a(b){a.__super__.constructor.call(this,b);this.current_job=null}a.prototype._doTick=function(){if(!this.current_job){if(!this.jobs.length){this._waitForJobs();return}this.current_job=this.jobs.shift()}if(this.current_job.run()){this.current_job.destroy(false);return this.current_job=null}};a.prototype.push=function(d,c,b){return this._appendJob(d,c,b)};a.prototype._doDestroy=function(){if(this.current_job){this.current_job.destroy(true);this.current_job=null}return a.__super__._doDestroy.call(this)};return a})();if(typeof exports!=="undefined"){exports.Background.JobQueue=Background.JobQueue}var __hasProp=Object.prototype.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};Background.JobList=(function(){__extends(a,Background._JobContainer);function a(b){a.__super__.constructor.call(this,b)}a.prototype._doTick=function(){var f,b,e,d,c;if(!this.jobs.length){this._waitForJobs();return}b=this.jobs.slice();c=[];for(e=0,d=b.length;e<d;e++){f=b[e];if(!f.run()){continue}this.jobs.splice(this.jobs.indexOf(f),1);c.push(f.destroy(false))}return c};a.prototype.append=function(d,c,b){return this._appendJob(d,c,b)};return a})();if(typeof exports!=="undefined"){exports.Background.JobList=Background.JobList}Background.Range=(function(){function a(b,c){this.index=b;this.excluded_boundary=c;if((this.index===void 0)||!this.excluded_boundary){throw new Error("Background.Range: parameters invalid")}return this}a.prototype.isDone=function(){return this.index>=this.excluded_boundary};a.prototype.step=function(){this.index++;if(this.index>=this.excluded_boundary){return -1}else{return this.index}};a.prototype.getItem=function(b){return b[this.index]};a.prototype.getSlice=function(b){return b.slice(this.index,this.excluded_boundary)};a.prototype._setIsDone=function(){this.index=-1;this.excluded_boundary=-1;return this};a.prototype._addBatchLength=function(b){if(!b){throw new Error("Background.Range._addBatchLength: batch_length invalid")}this.excluded_boundary+=b;return this};a.prototype.reset=function(){this.index=0;return this};a.prototype._stepToEnd=function(){return this.index=this.excluded_boundary};return a})();if(typeof exports!=="undefined"){exports.Background.Range=Background.Range}var __hasProp=Object.prototype.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};Background.ArrayIterator=(function(){__extends(a,Background._ArrayIterator);function a(d,c){var b;this.array=d;if(!this.array){throw new Error("Background.ArrayIterator: missing array")}this.reset();b=c<this.array.length?c:(this.array.length?this.array.length:1);a.__super__.constructor.call(this,c,this.array.length,new Background.Range(0,b))}a.prototype.nextByItem=function(b){this.step();while(!this.current_range.isDone()){b(this.current_range.getItem(this.array),this.current_range.index,this.array);this.current_range.step()}return this.isDone()};a.prototype.nextBySlice=function(b){this.step();if(!this.current_range.isDone()){b(this.current_range.getSlice(this.array),this.current_range,this.array)}this.current_range._stepToEnd();return this.isDone()};a.prototype.nextByRange=function(b){this.step();if(!this.current_range.isDone()){b(this.current_range,this.array)}return this.isDone()};return a})();if(typeof exports!=="undefined"){exports.Background.ArrayIterator=Background.ArrayIterator};