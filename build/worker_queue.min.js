(function(){var a=function(b,c){return function(){return b.apply(c,arguments)}};window.WQ||(window.WQ={});WQ.ASSERT=function(b,c){if(!window.DEBUG){return}if(!b){return alert(c)}};WQ.ArrayIterator=(function(){function b(d,c){this.batch_size=c;this.array=d;this.batch_count=Math.floor(this.array.length/this.batch_size)+1;this.batch_index=0;this.array_index=0}b.prototype.next_by_entry=function(c){var d;d=this.array_index+this.batch_size;if(d>this.array.length){d=this.array.length}while(this.array_index<d){if(c(this.array[this.array_index],this.array_index)){return true}this.array_index++}this.batch_index++;return this.batch_index===this.batch_count};b.prototype.next_by_slice=function(c){var d;d=this.array_index+this.batch_size;if(d>this.array.length){d=this.array.length}if((d-this.array_index)<=0){return true}if(c(this.array.slice(this.array_index,d))){return true}this.array_index+=this.batch_size;this.batch_index++;return this.batch_index===this.batch_count};return b})();WQ.Worker=(function(){function b(c,d,e){this.setup_callback=c;this.task=d;this.cleanup_callback=e;WQ.ASSERT(this.task,"missing task for worker");this.was_completed=false}b.prototype.destroy=function(){this._cleanup();this.task=null;this.setup_callback=null;return this.cleanup_callback=null};b.prototype.run=function(){if(this.setup_callback){try{this.setup_callback()}catch(c){WQ.ASSERT(null,"setup_callback failed because of '"+c.message+"'");return true}this.setup_callback=null}try{this.was_completed=this.task()}catch(c){WQ.ASSERT(null,"task failed because of '"+c.message+"'")}if(this.was_completed){this._cleanup()}return this.was_completed};b.prototype._cleanup=function(){if(this.cleanup_callback){try{this.cleanup_callback(this.was_completed)}catch(c){WQ.ASSERT(null,"setup_callback failed because of '"+c.message+"'")}return this.cleanup_callback=null}};return b})();WQ.WorkerQueue=(function(){function b(c){this.frequency=c;this.worker_queue=[];this.timeout=0;this.current_worker=null;this.being_destroyed=false}b.prototype.destroy=function(){return this.being_destroyed=true};b.prototype.isDestroyed=function(){return this.being_destroyed||this.destroyed};b.prototype.isEmpty=function(){return this.worker_queue.length===0};b.prototype.pop=function(){if(this.being_destroyed){this._do_destroy();return}if(!this.current_worker){if(!this.worker_queue.length){window.clearInterval(this.timeout);this.timeout=0;return}this.current_worker=this.worker_queue.shift()}if(this.current_worker.run()){this.current_worker.destroy(false);return this.current_worker=null}else{if(this.being_destroyed){this._do_destroy()}}};b.prototype.push=function(c,d,e){WQ.ASSERT(!this.isDestroyed(),"push shouldn't happen after destroy");if(this.isDestroyed()){return}this.worker_queue.push(new WQ.Worker(c,d,e));if(!this.timeout){this.timeout=window.setInterval((a(function(){return this.pop()},this)),this.frequency)}if(!this.current_worker){return this.pop()}};b.prototype._do_destroy=function(){var c;WQ.ASSERT(this.being_destroyed,"not in destroy");WQ.ASSERT(!this.is_destroyed,"already destroyed");if(this.is_destroyed){return}this.is_destroyed=true;if(this.current_worker){this.current_worker.destroy(true);this.current_worker=null}while((c=this.worker_queue.shift())){c.destroy(true)}window.clearInterval(this.timeout);return this.timeout=0};return b})();if(typeof exports!=="undefined"){exports.WQ.ArrayIterator=WQ.ArrayIterator;exports.WQ.WorkerQueue=WQ.WorkerQueue}}).call(this);